---
phase: 05-demo-integration
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - frontend/src/components/DemoControlBar.tsx
  - frontend/src/hooks/useDemoControl.ts
  - frontend/src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Control bar shows Start/Pause/Reset buttons visible to audience"
    - "Speed presets (Normal/Fast/Slow) change demo pacing"
    - "Simulated clock displays scenario time advancing T+0h to T+72h"
    - "Controls integrate into existing dashboard without breaking layout"
  artifacts:
    - path: "frontend/src/components/DemoControlBar.tsx"
      provides: "Demo control bar React component"
      min_lines: 80
    - path: "frontend/src/hooks/useDemoControl.ts"
      provides: "Hook for demo API communication and state polling"
      min_lines: 40
    - path: "frontend/src/components/DashboardLayout.tsx"
      provides: "Updated layout integrating control bar"
      contains: "DemoControlBar"
  key_links:
    - from: "frontend/src/hooks/useDemoControl.ts"
      to: "/api/demo"
      via: "fetch calls to FastAPI"
      pattern: "fetch.*api/demo"
    - from: "frontend/src/components/DemoControlBar.tsx"
      to: "frontend/src/hooks/useDemoControl.ts"
      via: "hook usage"
      pattern: "useDemoControl"
    - from: "frontend/src/components/DashboardLayout.tsx"
      to: "frontend/src/components/DemoControlBar.tsx"
      via: "component import and render"
      pattern: "DemoControlBar"
---

<objective>
Build the demo control bar UI component that lets the presenter control playback with Start/Pause/Reset buttons, speed presets, and a simulated scenario clock -- all visible to the audience during the demo.

Purpose: The control bar is how the presenter interacts with the demo engine. It needs to be visible but not dominant -- a thin bar that the audience can see adds credibility ("this is live, the presenter is controlling it"). The simulated clock (T+0h -> T+72h) helps the audience understand the time compression.

Output: `DemoControlBar.tsx` component, `useDemoControl.ts` hook, updated `DashboardLayout.tsx`
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-integration/05-CONTEXT.md

# Key source files
@frontend/src/components/DashboardLayout.tsx
@frontend/src/components/ThreatBanner.tsx
@frontend/src/lib/supabase.ts
@frontend/src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDemoControl hook and DemoControlBar component</name>
  <files>frontend/src/hooks/useDemoControl.ts, frontend/src/components/DemoControlBar.tsx</files>
  <action>
**First, create `frontend/src/hooks/useDemoControl.ts`:**

Custom hook that communicates with the FastAPI demo control API and polls for status.

```typescript
// API base URL - configurable, defaults to localhost:8000
const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8000'

interface DemoStatus {
  state: 'idle' | 'playing' | 'paused'
  speed: number
  speed_label: string
  progress: number
  records_inserted: number
  total_records: number
  simulated_time: string    // "T+32h"
  simulated_hours: number   // 32.4
}
```

The hook should:
1. Store `status: DemoStatus | null` in state
2. Poll `/api/demo/status` every 500ms ONLY when state is "playing" (use setInterval that starts/stops based on status.state)
3. Expose action functions that call API and update local status:
   - `start(clearFirst?: boolean)` -> POST `/api/demo/start?clear_first={clearFirst}`
   - `pause()` -> POST `/api/demo/pause`
   - `reset()` -> POST `/api/demo/reset`
   - `setSpeed(preset: 'normal' | 'fast' | 'slow')` -> POST `/api/demo/speed?preset={preset}`
4. Fetch initial status on mount
5. Return `{ status, start, pause, reset, setSpeed, loading, error }`

Use plain `fetch()` for API calls (no need for axios). Handle errors gracefully -- if API unreachable, set error state but don't crash.

**Then, create `frontend/src/components/DemoControlBar.tsx`:**

A thin control bar that sits below the threat banner. Design should be subtle but visible.

Layout (single row, ~36px height):
```
[Play/Pause button] [Reset button] | [Normal] [Fast] [Slow] | T+24h | 45% complete
```

Implementation details:

1. **Play/Pause toggle button:**
   - When idle or paused: Show play icon (triangle) with "Start" or "Resume" text
   - When playing: Show pause icon (two bars) with "Pause" text
   - On first Start click: call `start(true)` (clear tables first)
   - On Resume from paused: call `start(false)` (don't clear)
   - Use lucide-react icons: `Play`, `Pause`, `RotateCcw` (for reset)

2. **Reset button:**
   - Always visible, calls `reset()`
   - Disabled while state is "idle" and no progress
   - Use `RotateCcw` icon from lucide-react

3. **Speed preset buttons:**
   - Three buttons: "Normal", "Fast", "Slow"
   - Active button highlighted (bg-slate-700 text-white vs bg-slate-100 text-slate-600)
   - Map to speed labels from API

4. **Simulated clock display:**
   - Show `status.simulated_time` (e.g., "T+24h")
   - Use monospace font for the time value (`font-mono`)
   - Small label "Scenario Time" above or beside

5. **Progress indicator:**
   - Show percentage: `Math.round(status.progress * 100)%`
   - Thin progress bar (2px height) spanning full width of control bar, colored by current threat phase:
     - 0-33%: emerald-500 (GREEN phase)
     - 33-67%: amber-500 (AMBER phase)
     - 67-100%: red-600 (RED phase)

**Styling:**
- Background: `bg-white border-b border-slate-200`
- Text: `text-xs text-slate-600`
- Buttons: Small pill buttons with slate palette, matching the dashboard's professional aesthetic
- Height: `h-9` (36px)
- Padding: `px-4`
- Use flex layout with gap-3 between groups, dividers via `border-l border-slate-200 pl-3`

**State handling:**
- While API is unreachable: Show "Backend not connected" in red text, disable all buttons
- While idle with no progress: Show "Ready" state, only Start enabled
- While playing: Disable Start, enable Pause/Reset
- While paused: Enable Resume/Reset
  </action>
  <verify>
Run: `cd "/Users/gremmy/02. Projects/dragon-watch/frontend" && npx tsc --noEmit`
TypeScript compilation should succeed with no errors in the new files.
  </verify>
  <done>
DemoControlBar component renders with Play/Pause/Reset buttons, speed presets, simulated clock, and progress bar. useDemoControl hook polls API and exposes control functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate control bar into dashboard layout</name>
  <files>frontend/src/components/DashboardLayout.tsx</files>
  <action>
Read the current `DashboardLayout.tsx` first.

Update the grid layout to include the DemoControlBar between the ThreatBanner and the main content area.

Current grid: `grid-cols-[320px_1fr_360px] grid-rows-[48px_1fr_200px]`

Updated grid: `grid-cols-[320px_1fr_360px] grid-rows-[48px_36px_1fr_200px]`

This adds a new 36px row for the control bar.

Changes:
1. Import `DemoControlBar` at the top
2. Add the control bar row after ThreatBanner, spanning full width:
   ```tsx
   {/* Demo Control Bar - Below banner, full width */}
   <div className="col-span-3" style={{ gridArea: '2 / 1 / 3 / 4' }}>
     <DemoControlBar />
   </div>
   ```
3. Update all existing panel grid areas to shift down by 1 row:
   - Event Feed: was `2 / 1 / 4 / 2` -> `3 / 1 / 5 / 2`
   - MapPanel: adjust to row 3
   - NarrativeTimeline: was `3 / 2 / 4 / 3` -> `4 / 2 / 5 / 3`
   - BriefPanel: was `2 / 3 / 4 / 4` -> `3 / 3 / 5 / 4`

Verify the banner still has `gridArea: '1 / 1 / 2 / 4'` (unchanged).

IMPORTANT: Keep all existing component imports and rendering logic. Only change the grid template and grid area assignments.
  </action>
  <verify>
Run: `cd "/Users/gremmy/02. Projects/dragon-watch/frontend" && npm run build`
Build should succeed. The DemoControlBar should appear in the rendered layout between banner and content.
  </verify>
  <done>
Dashboard layout includes DemoControlBar in a dedicated 36px row between threat banner and main content. All existing panels render in their correct zones with adjusted grid areas.
  </done>
</task>

</tasks>

<verification>
1. `DemoControlBar.tsx` renders with all control elements
2. `useDemoControl.ts` polls API and exposes control functions
3. `DashboardLayout.tsx` includes control bar without breaking existing panels
4. `npm run build` succeeds in frontend directory
5. TypeScript compilation passes with no errors
</verification>

<success_criteria>
- Control bar visible between threat banner and main dashboard
- Start/Pause/Reset buttons functional (call correct API endpoints)
- Speed preset buttons toggle active state
- Simulated clock shows T+Xh format
- Progress bar fills based on demo progress
- Dashboard layout intact -- all 5 existing zones render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-integration/05-03-SUMMARY.md`
</output>
