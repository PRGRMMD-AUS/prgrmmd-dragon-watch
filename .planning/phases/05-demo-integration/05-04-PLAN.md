---
phase: 05-demo-integration
plan: 04
type: execute
wave: 4
depends_on: ["05-02", "05-03"]
files_modified:
  - scripts/verify_phase_5.py
autonomous: false

must_haves:
  truths:
    - "Demo starts and all 5 dashboard panels update via Supabase realtime"
    - "Threat banner escalates GREEN to AMBER to RED during playback"
    - "Control bar responds to user input (pause, resume, speed change, reset)"
    - "Simulated clock advances from T+0h to T+72h"
    - "Demo completes full scenario in approximately 5 minutes at normal speed"
  artifacts:
    - path: "scripts/verify_phase_5.py"
      provides: "Automated verification of demo infrastructure"
      min_lines: 50
  key_links:
    - from: "frontend/src/hooks/useDemoControl.ts"
      to: "src/main.py"
      via: "HTTP fetch to /api/demo endpoints"
      pattern: "api/demo"
    - from: "src/demo/engine.py"
      to: "Supabase realtime"
      via: "INSERT/UPDATE triggers realtime subscriptions"
      pattern: "insert|upsert|update"
    - from: "frontend/src/hooks/useRealtimeSubscription.ts"
      to: "Supabase"
      via: "postgres_changes subscription receives engine inserts"
      pattern: "postgres_changes"
---

<objective>
Verify the complete demo integration works end-to-end: backend engine inserts data, frontend receives it via realtime, all panels update, and controls work. Includes both automated checks and human visual verification.

Purpose: This is the final integration plan for Phase 5 (and the entire project). Everything built in Phases 1-4 plus Plans 01-03 must work together seamlessly for the hackathon demo. The human checkpoint ensures the visual experience meets presentation quality.

Output: `scripts/verify_phase_5.py` (automated checks) and human-verified demo flow
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-demo-integration/05-CONTEXT.md
@.planning/phases/05-demo-integration/05-01-SUMMARY.md
@.planning/phases/05-demo-integration/05-02-SUMMARY.md
@.planning/phases/05-demo-integration/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 5 verification script and run automated checks</name>
  <files>scripts/verify_phase_5.py</files>
  <action>
Create `scripts/verify_phase_5.py` that verifies the demo infrastructure is correctly wired:

**Check 1: Fixture file exists and is valid**
- Load `scripts/demo_fixture.json`
- Verify 7 table types present
- Verify records sorted by _demo_offset_seconds
- Verify alert escalation: GREEN -> GREEN -> AMBER -> AMBER -> RED
- Print record counts per table

**Check 2: Demo engine importable and functional**
- Import DemoEngine from src.demo.engine
- Verify load_fixture() works
- Verify get_status() returns expected shape
- Verify speed presets map correctly

**Check 3: FastAPI endpoints registered**
- Import app from src.main
- Check that routes include /api/demo/start, /api/demo/pause, /api/demo/reset, /api/demo/speed, /api/demo/status
- Print all registered demo routes

**Check 4: Frontend build succeeds**
- Run `npm run build` in frontend directory (subprocess)
- Verify exit code 0
- Check that dist/ directory exists after build

**Check 5: Quick insertion test**
- Start engine with a 3-record subset (first 3 records from fixture)
- Insert them into Supabase
- Query Supabase to verify records appeared
- Clean up (delete inserted records)

Print results as:
```
Phase 5 Verification
====================
[PASS] Fixture file valid (247 records across 7 tables)
[PASS] Demo engine loads and initializes
[PASS] FastAPI demo routes registered (5 endpoints)
[PASS] Frontend builds successfully
[PASS] Quick insertion test (3 records inserted and verified)

5/5 checks passed. Demo infrastructure ready.
```

Run the script: `python scripts/verify_phase_5.py`
  </action>
  <verify>
`python scripts/verify_phase_5.py` outputs all checks passing. If any check fails, debug and fix the underlying issue before proceeding to human verification.
  </verify>
  <done>
All 5 automated verification checks pass. Demo infrastructure confirmed working: fixture valid, engine functional, API endpoints registered, frontend builds, Supabase insertion verified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Dragon Watch demo system: playback engine inserts pre-computed Taiwan Strait escalation data into Supabase, dashboard receives updates via realtime subscriptions, control bar allows presenter to manage playback.
  </what-built>
  <how-to-verify>
**Setup (run these in separate terminals):**

1. Terminal 1 -- Start FastAPI backend:
   ```
   cd "/Users/gremmy/02. Projects/dragon-watch"
   python -m uvicorn src.main:app --host 0.0.0.0 --port 8000
   ```

2. Terminal 2 -- Start Vite frontend:
   ```
   cd "/Users/gremmy/02. Projects/dragon-watch/frontend"
   npm run dev
   ```

3. Open browser to http://localhost:5173

**Verification steps:**

1. **Layout check:** Dashboard shows 6 zones: threat banner (top), demo control bar (below banner), event feed (left), map (center), timeline (bottom), brief (right). Control bar has Start/Pause/Reset buttons, speed presets, and "T+0h" clock.

2. **Start demo (Normal speed):** Click "Start" in control bar.
   - Verify: Records begin appearing in the event feed (articles and posts trickling in)
   - Verify: Vessel positions appear on the map
   - Verify: Simulated clock starts advancing (T+0h, T+1h, T+2h...)
   - Verify: Progress bar fills gradually

3. **Pause and resume:** Click "Pause" after ~30 seconds.
   - Verify: Data stops flowing
   - Verify: Clock and progress freeze
   - Click "Resume" (or Start again)
   - Verify: Data flow resumes from where it paused

4. **Speed change:** Switch to "Fast" preset.
   - Verify: Data flows noticeably faster
   - Switch to "Slow" and verify it slows down

5. **Threat escalation (let it run to completion on Fast):**
   - Watch threat banner: Should start GREEN, transition to AMBER (pulse animation), then RED (pulse animation)
   - Watch timeline panel: Threat score line should climb
   - Watch brief panel: Intelligence briefs should appear (GREEN assessment, then AMBER, then RED)
   - Watch event feed: Article tone should shift from neutral to aggressive military language

6. **Climax moment:** When banner turns RED:
   - Banner should pulse red briefly
   - Confidence should be >90%
   - Brief panel should show RED threat assessment
   - This is the "money shot" for the hackathon demo

7. **Reset:** Click "Reset".
   - Verify: All panels clear
   - Verify: Banner returns to initial state
   - Verify: Clock resets to T+0h
   - Verify: Can start a fresh demo run

8. **Record backup video:** After approving the live demo, record a full screen capture of the demo running at Normal speed as a pre-recorded video fallback in case live demo fails at the hackathon.

**What to look for:**
- Smooth data flow (no visible batching or stuttering)
- All 5 dashboard panels updating in sync
- Professional appearance suitable for hackathon presentation
- No console errors in browser dev tools
  </how-to-verify>
  <resume-signal>Type "approved" if demo flows correctly GREEN to RED with all panels updating. Describe any issues if fixes needed.</resume-signal>
</task>

</tasks>

<verification>
1. `scripts/verify_phase_5.py` passes all 5 automated checks
2. Human verifies complete demo flow: start -> GREEN -> AMBER -> RED -> reset
3. All 5 dashboard panels update via Supabase realtime during demo
4. Control bar responsive to all user actions
5. Demo completes in ~5 minutes at Normal speed, ~2 minutes at Fast
</verification>

<success_criteria>
- DEMO-01: Playback engine steps through scenario at controlled speed -- VERIFIED
- DEMO-02: Descoped per user decision (optional, pre-computed only)
- DEMO-03: No live API calls needed, Supabase required (per user decision) -- VERIFIED
- DEMO-04: All panels update via realtime subscriptions -- VERIFIED
- DEMO-05: GREEN to RED escalation in ~5 minutes -- VERIFIED
- Human approves demo quality for hackathon presentation
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-integration/05-04-SUMMARY.md`
</output>
