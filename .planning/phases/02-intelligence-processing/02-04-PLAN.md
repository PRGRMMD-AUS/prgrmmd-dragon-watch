---
phase: 02-intelligence-processing
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - backend/llm/briefs.py
  - backend/processors/brief_generator.py
autonomous: true

must_haves:
  truths:
    - "Intelligence briefs are generated from narrative_events and movement_events data with threat level (GREEN/AMBER/RED), confidence, and evidence chain"
    - "Brief includes timeline of events, information gaps, and collection priorities"
    - "Brief links to specific articles and posts that triggered the assessment (evidence traceability)"
    - "Brief is written to briefs table in Supabase"
  artifacts:
    - path: "backend/llm/briefs.py"
      provides: "generate_intelligence_brief() — produces IntelligenceBrief from narrative + movement data"
      contains: "async def generate_intelligence_brief"
    - path: "backend/processors/brief_generator.py"
      provides: "generate_brief() — reads events from Supabase, generates brief, writes to briefs table"
      contains: "async def generate_brief"
  key_links:
    - from: "backend/llm/briefs.py"
      to: "backend/llm/schemas.py"
      via: "IntelligenceBrief and ThreatLevel schemas"
      pattern: "from backend\\.llm\\.schemas import IntelligenceBrief"
    - from: "backend/llm/briefs.py"
      to: "backend/llm/clients.py"
      via: "AsyncAnthropic client for Claude"
      pattern: "from backend\\.llm\\.clients import get_anthropic_client"
    - from: "backend/processors/brief_generator.py"
      to: "backend/llm/briefs.py"
      via: "Calls generate_intelligence_brief with event data"
      pattern: "generate_intelligence_brief"
---

<objective>
Implement the intelligence brief generator (LLM-04) with a pipeline that reads narrative_events and movement_events from Supabase, generates formatted threat assessments via Claude, and writes completed briefs to the briefs table.

Purpose: Intelligence briefs are the primary output of the analysis system — the formatted assessment that analysts read. They synthesize both intelligence streams (narrative coordination + civilian movement) into actionable threat assessments with evidence chains, making the system's conclusions interpretable and auditable.

Output: `backend/llm/briefs.py` (LLM-04), `backend/processors/brief_generator.py` (pipeline).
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-intelligence-processing/02-RESEARCH.md
@.planning/phases/02-intelligence-processing/02-01-SUMMARY.md
@.planning/phases/02-intelligence-processing/02-02-SUMMARY.md
@.planning/phases/02-intelligence-processing/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement intelligence brief generator</name>
  <files>
    backend/llm/briefs.py
  </files>
  <action>
    Create `backend/llm/briefs.py` with:

    1. Helper functions for formatting input data:
       - `def format_narrative_events(events: List[dict]) -> str`:
         Format each event as: "- {outlet_count} outlets, score {coordination_score}, phrases: {synchronized_phrases[:3]}, focus: {geographic_focus}"
       - `def format_movement_events(events: List[dict]) -> str`:
         Format each event as: "- {category}: {location}, confidence {confidence}, post_id: {post_id}"

    2. `async def generate_intelligence_brief(narrative_events: List[dict], movement_events: List[dict], time_window_hours: int = 72) -> IntelligenceBrief`:
       - Accept narrative_events and movement_events as lists of dicts (from Supabase queries)
       - Format events using helper functions
       - Build prompt with XML tags:
         ```
         <instructions>
         Generate an intelligence assessment from the following dual-stream analysis data.

         You are producing a UNCLASSIFIED // FOR EXERCISE USE ONLY intelligence brief for a pre-conflict early warning system monitoring the Taiwan Strait region.

         Produce:
         1. Threat Level: GREEN (routine, score <30) / AMBER (elevated, 30-70) / RED (critical, >70)
            Base on: narrative coordination strength, movement cluster size, geographic proximity, temporal alignment
         2. Confidence (0-100): How certain is this threat assessment
         3. Executive Summary: 2-3 sentences describing the current situation
         4. Evidence Chain: List specific data points (articles, posts) supporting the assessment
         5. Timeline: Chronological sequence of key events in the analysis window
         6. Information Gaps: What information is missing or unclear
         7. Collection Priorities: Recommended next collection targets (specific outlets, geographic areas, source types)

         Intelligence analysis standards:
         - Clearly separate confirmed facts from analytical assessments
         - Hedge confidence based on source count and reliability
         - Identify at least one alternative hypothesis
         - Flag any single-source assessments
         </instructions>

         <narrative_stream>
         Time window: {time_window_hours} hours
         Events:
         {formatted narrative events}
         </narrative_stream>

         <movement_stream>
         Events:
         {formatted movement events}
         </movement_stream>
         ```
       - Use get_anthropic_client() with output_format=IntelligenceBrief
       - Use Claude Sonnet (settings.claude_model) — briefs need high-quality reasoning
       - Apply retry decorator, log with structlog
       - Handle edge cases: empty narrative_events -> note in information_gaps, empty movement_events -> note in information_gaps
  </action>
  <verify>
    - `python -c "from backend.llm.briefs import generate_intelligence_brief, format_narrative_events, format_movement_events; print('Briefs OK')"` succeeds
    - generate_intelligence_brief is async
    - Prompt includes XML tags and intelligence analysis standards
    - Function handles empty event lists without crashing
  </verify>
  <done>
    Intelligence brief generator accepts narrative_events and movement_events, produces IntelligenceBrief with threat level, confidence, summary, evidence chain, timeline, information gaps, and collection priorities. Uses Claude Sonnet for high-quality analysis reasoning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement brief generation pipeline</name>
  <files>
    backend/processors/brief_generator.py
  </files>
  <action>
    Create `backend/processors/brief_generator.py` with:

    1. `async def fetch_recent_narrative_events(supabase_client, hours: int = 72) -> List[dict]`:
       - Query narrative_events table for events within last N hours
       - Order by created_at DESC
       - Use asyncio.to_thread() for Supabase client

    2. `async def fetch_recent_movement_events(supabase_client, hours: int = 72) -> List[dict]`:
       - Query movement_events table for events within last N hours
       - Order by created_at DESC
       - Use asyncio.to_thread() for Supabase client

    3. `async def write_brief(supabase_client, brief: IntelligenceBrief, narrative_event_ids: List[str], movement_event_ids: List[str]) -> dict`:
       - Insert into briefs table with fields:
         - threat_level, confidence, summary
         - evidence_chain (JSON array)
         - timeline
         - information_gaps (JSON array)
         - collection_priorities (JSON array)
         - narrative_event_ids (array of source event UUIDs — traceability)
         - movement_event_ids (array of source event UUIDs — traceability)
         - created_at (UTC timestamp)
       - Use asyncio.to_thread() for Supabase write

    4. `async def generate_brief(time_window_hours: int = 72) -> dict`:
       - Main pipeline orchestrator:
         a. Initialize Supabase client
         b. Fetch recent narrative_events and movement_events concurrently (asyncio.gather)
         c. If both streams empty, log "no events" and return early
         d. Call generate_intelligence_brief with event data
         e. Write brief to Supabase with event IDs for traceability
         f. Return summary dict: threat_level, confidence, narrative_events_count, movement_events_count, brief_id
       - Wrap in try/except with structured logging
       - Log: time window, event counts, threat level produced, processing duration

    5. `if __name__ == "__main__":` block:
       ```python
       import asyncio
       asyncio.run(generate_brief())
       ```
  </action>
  <verify>
    - `python -c "from backend.processors.brief_generator import generate_brief; print('Brief Pipeline OK')"` succeeds
    - generate_brief is async
    - Pipeline fetches both event streams concurrently (asyncio.gather)
    - Brief includes narrative_event_ids and movement_event_ids for evidence traceability
    - Handles empty event streams gracefully
  </verify>
  <done>
    Brief generation pipeline reads recent narrative_events and movement_events from Supabase, generates intelligence brief via Claude, writes to briefs table with full evidence traceability (linked event IDs). Handles empty streams gracefully.
  </done>
</task>

</tasks>

<verification>
- `python -c "from backend.llm.briefs import generate_intelligence_brief; from backend.processors.brief_generator import generate_brief; print('Phase 2 Plan 04 OK')"` succeeds
- Brief includes all required fields: threat_level, confidence, summary, evidence_chain, timeline, information_gaps, collection_priorities
- Pipeline links brief to source event IDs (evidence traceability)
- Both event streams are fetched concurrently
- Uses Claude Sonnet (not GPT-4o Mini) for brief generation quality
</verification>

<success_criteria>
- generate_intelligence_brief() produces IntelligenceBrief from narrative + movement events
- Brief includes threat_level (GREEN/AMBER/RED), confidence, summary, evidence chain, timeline, gaps, priorities
- generate_brief() pipeline: fetch events -> generate brief -> write to Supabase
- Evidence traceability: brief links to specific narrative_event_ids and movement_event_ids
- Handles empty event streams (one or both) without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/02-intelligence-processing/02-04-SUMMARY.md`
</output>
