---
phase: 04-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/vite.config.ts
  - frontend/tsconfig.json
  - frontend/tsconfig.app.json
  - frontend/tsconfig.node.json
  - frontend/tailwind.config.ts
  - frontend/postcss.config.js
  - frontend/index.html
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/src/index.css
  - frontend/src/lib/supabase.ts
  - frontend/src/types/database.ts
  - frontend/src/hooks/useRealtimeSubscription.ts
  - frontend/src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - "React dev server starts and renders the dashboard layout shell in a browser"
    - "Supabase client connects and can query the articles table"
    - "Dashboard layout shows all five panel zones (top banner, left feed, center map, bottom timeline, right brief)"
    - "Alerts and briefs tables have the extended columns needed by the correlation engine and frontend"
  artifacts:
    - path: "frontend/package.json"
      provides: "React + Vite + Tailwind + shadcn/ui + Supabase dependencies"
      contains: "@supabase/supabase-js"
    - path: "frontend/src/lib/supabase.ts"
      provides: "Supabase client singleton"
      contains: "createClient"
    - path: "frontend/src/types/database.ts"
      provides: "TypeScript types for all Supabase tables"
      contains: "Article"
    - path: "frontend/src/hooks/useRealtimeSubscription.ts"
      provides: "Generic realtime subscription hook"
      contains: "useEffect"
    - path: "frontend/src/components/DashboardLayout.tsx"
      provides: "5-zone CSS Grid layout shell"
      contains: "grid"
  key_links:
    - from: "frontend/src/lib/supabase.ts"
      to: "Supabase project czyqiqgssvebgatxprey"
      via: "createClient with URL and anon key"
      pattern: "createClient.*czyqiqgssvebgatxprey"
    - from: "frontend/src/hooks/useRealtimeSubscription.ts"
      to: "frontend/src/lib/supabase.ts"
      via: "import supabase client"
      pattern: "import.*supabase"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/DashboardLayout.tsx"
      via: "renders DashboardLayout"
      pattern: "DashboardLayout"
---

<objective>
Scaffold the React frontend project and create the dashboard layout foundation.

Purpose: Everything in Phase 4 depends on having a working React project with Supabase connectivity and the 5-zone layout shell. This plan also migrates the Supabase alerts and briefs tables to add the extended columns the correlation engine and brief generator write to (threat_level, confidence, sub_scores, correlation_metadata, etc.), which the frontend must read.

Output: A running React dev server showing the empty 5-zone dashboard layout, connected to Supabase, with a generic realtime subscription hook ready for all panels to use.
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization/04-CONTEXT.md
@src/models/schemas.py
@src/models/correlation.py
@src/processors/correlate_events.py
@src/processors/brief_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Supabase alerts and briefs tables</name>
  <files>
    (Supabase migration via MCP — no local files)
  </files>
  <action>
    Apply a Supabase migration to extend the alerts and briefs tables with the columns the backend code already writes to.

    **alerts table — add columns:**
    - `region` TEXT DEFAULT 'Taiwan Strait'
    - `threat_level` TEXT DEFAULT 'GREEN' (CHECK: GREEN, AMBER, RED)
    - `threat_score` DOUBLE PRECISION DEFAULT 0
    - `confidence` INTEGER DEFAULT 0
    - `sub_scores` JSONB DEFAULT '{}'
    - `correlation_metadata` JSONB DEFAULT '{}'
    - `updated_at` TIMESTAMPTZ DEFAULT now()

    **briefs table — add columns:**
    - `threat_level` TEXT DEFAULT 'GREEN'
    - `confidence` INTEGER DEFAULT 0
    - `evidence_chain` TEXT[] DEFAULT '{}'
    - `timeline` TEXT[] DEFAULT '{}'
    - `information_gaps` TEXT[] DEFAULT '{}'
    - `collection_priorities` TEXT[] DEFAULT '{}'
    - `narrative_event_ids` JSONB DEFAULT '[]'
    - `movement_event_ids` JSONB DEFAULT '[]'

    Use the `apply_migration` MCP tool. Name the migration `extend_alerts_and_briefs_for_frontend`.

    WHY: The correlation engine (correlate_events.py) and brief generator (brief_generator.py) already write to these columns. Without them, Supabase silently drops the data. The frontend needs these columns to display threat levels, confidence, sub-scores, and intelligence briefs.
  </action>
  <verify>
    Run SQL query: `SELECT column_name FROM information_schema.columns WHERE table_name = 'alerts' AND table_schema = 'public' ORDER BY ordinal_position;` — must include threat_level, threat_score, confidence, sub_scores, correlation_metadata, region, updated_at.
    Run SQL query: `SELECT column_name FROM information_schema.columns WHERE table_name = 'briefs' AND table_schema = 'public' ORDER BY ordinal_position;` — must include threat_level, confidence, evidence_chain, timeline, information_gaps, collection_priorities.
  </verify>
  <done>Both alerts and briefs tables have all extended columns. Existing rows are preserved with defaults applied.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold React + Vite + Tailwind + Supabase project</name>
  <files>
    frontend/package.json
    frontend/vite.config.ts
    frontend/tsconfig.json
    frontend/tsconfig.app.json
    frontend/tsconfig.node.json
    frontend/tailwind.config.ts
    frontend/postcss.config.js
    frontend/index.html
    frontend/src/main.tsx
    frontend/src/App.tsx
    frontend/src/index.css
    frontend/src/lib/supabase.ts
    frontend/src/types/database.ts
    frontend/src/hooks/useRealtimeSubscription.ts
  </files>
  <action>
    Create a new React project in the `frontend/` directory at the project root. Use Vite with the React-TS template.

    Steps:
    1. Run `npm create vite@latest frontend -- --template react-ts` from the project root
    2. `cd frontend && npm install`
    3. Install Tailwind CSS v3: `npm install -D tailwindcss @tailwindcss/vite` and configure in vite.config.ts using the @tailwindcss/vite plugin
    4. Set up `src/index.css` with `@import "tailwindcss";`
    5. Install shadcn/ui dependencies: `npx shadcn@latest init` — choose default style, slate base color, CSS variables enabled. If interactive prompts block, manually install: `npm install class-variance-authority clsx tailwind-merge lucide-react` and create `frontend/src/lib/utils.ts` with the `cn()` helper.
    6. Install Supabase client: `npm install @supabase/supabase-js`
    7. Install Recharts for the timeline: `npm install recharts`
    8. Install react-map-gl + mapbox-gl for the map: `npm install react-map-gl mapbox-gl` and `npm install -D @types/mapbox-gl`

    Create `frontend/src/lib/supabase.ts`:
    ```typescript
    import { createClient } from '@supabase/supabase-js'

    const supabaseUrl = 'https://czyqiqgssvebgatxprey.supabase.co'
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6eXFpcWdzc3ZlYmdhdHhwcmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTk0OTEsImV4cCI6MjA4NTk3NTQ5MX0.ybaRf3DL34eJHqWvHjS8yfcql_-hmlsuLW8zZgMR5K4'

    export const supabase = createClient(supabaseUrl, supabaseAnonKey)
    ```

    Create `frontend/src/types/database.ts` with TypeScript interfaces mirroring the Supabase tables:
    - `Article`: id, url, title, domain, published_at, tone_score, language, source_country, created_at
    - `SocialPost`: id, telegram_id, channel, text, timestamp, views, created_at
    - `VesselPosition`: id, mmsi, ship_name, latitude, longitude, speed, course, timestamp, created_at
    - `NarrativeEvent`: id, event_type, summary, confidence, source_ids, detected_at
    - `MovementEvent`: id, event_type, vessel_mmsi, location_lat, location_lon, description, detected_at
    - `Alert`: id, severity, title, description, event_ids, created_at, resolved_at, region, threat_level, threat_score, confidence, sub_scores, correlation_metadata, updated_at
    - `Brief`: id, title, summary, key_developments, generated_at, threat_level, confidence, evidence_chain, timeline, information_gaps, collection_priorities, narrative_event_ids, movement_event_ids
    - `ThreatLevel` type: 'GREEN' | 'AMBER' | 'RED'

    Create `frontend/src/hooks/useRealtimeSubscription.ts`:
    A generic hook that subscribes to Supabase realtime INSERT events on a given table and appends new rows to state. Should accept table name and optional filter. Returns data array and loading boolean. Cleans up subscription on unmount. Also supports UPDATE events for the alerts table.

    WHY this approach: The user decided Lovable for frontend, but we scaffold manually with the same stack (React + Vite + Tailwind + shadcn/ui + Supabase) since no Lovable project exists. This gives us full control for the custom map and chart components.
  </action>
  <verify>
    From the frontend directory, run `npm run dev` and confirm it starts without errors. Open http://localhost:5173 in browser — should show the default React page. Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>React dev server runs, all dependencies installed, Supabase client file exists with correct URL/key, TypeScript types defined for all 7 tables, realtime hook implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Create 5-zone dashboard layout shell</name>
  <files>
    frontend/src/components/DashboardLayout.tsx
    frontend/src/App.tsx
    frontend/src/index.css
  </files>
  <action>
    Create the dashboard layout component with CSS Grid matching the user's vision:

    **Layout zones:**
    - **Top**: Full-width threat status banner (~48px height). Background color changes by threat level.
    - **Left**: Event feed panel (~320px wide). Scrollable column of cards.
    - **Center**: Map panel (fills remaining space, ~50% of viewport height). This is the dominant visual element.
    - **Bottom**: Narrative timeline panel (~200px height, spans from left edge to right sidebar edge).
    - **Right**: Intelligence brief sidebar (~360px wide, full height minus banner).

    Implementation:
    ```
    Grid layout (approximate):
    "banner  banner  banner"  48px
    "feed    map     brief"   1fr
    "timeline timeline brief" 200px
    ```

    - Use CSS Grid with `grid-template-areas` for named zones
    - Set `height: 100vh` on the dashboard container
    - Left panel: `overflow-y: auto` for scrolling
    - Right sidebar: `overflow-y: auto` for brief scrolling
    - Light theme: white/gray-50 backgrounds, subtle borders between zones
    - Each zone renders a placeholder div with the zone name and a subtle border, using Tailwind classes

    Update `App.tsx` to render `<DashboardLayout />` (remove Vite boilerplate).

    Update `index.css`: Set body margin to 0, font-family to Inter/system sans-serif, background to white.

    WHY this layout: User specified map dominates center/top (~50%), left panel for stacking event cards, bottom panel for narrative timeline, right sidebar for intelligence brief, top full-width threat banner. Light theme throughout.
  </action>
  <verify>
    Run `npm run dev`, open browser. Dashboard shows 5 labeled zones in the correct positions: banner across top, feed on left, map in center, timeline across bottom, brief on right. No scrollbars on the overall page (each zone scrolls internally). Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>Dashboard layout renders with 5 clearly defined zones matching the user's vision. All zones are labeled placeholders ready for panel components. Light theme applied.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run dev` starts without errors
2. Browser shows 5-zone layout at http://localhost:5173
3. `npx tsc --noEmit` passes with no type errors
4. Supabase alerts table has columns: threat_level, threat_score, confidence, sub_scores, correlation_metadata, region, updated_at
5. Supabase briefs table has columns: threat_level, confidence, evidence_chain, timeline, information_gaps, collection_priorities
6. `frontend/src/lib/supabase.ts` exports a connected client
7. `frontend/src/hooks/useRealtimeSubscription.ts` exists and compiles
</verification>

<success_criteria>
- React + Vite + Tailwind + shadcn/ui project runs in frontend/ directory
- Supabase client configured with correct project URL and anon key
- TypeScript types exist for all 7 database tables including extended alert/brief columns
- Generic realtime subscription hook implemented
- 5-zone CSS Grid layout renders correctly in browser
- Database schema updated with all columns the backend writes to
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization/04-01-SUMMARY.md`
</output>
