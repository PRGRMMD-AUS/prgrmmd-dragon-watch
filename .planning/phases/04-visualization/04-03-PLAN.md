---
phase: 04-visualization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/EventFeed.tsx
  - frontend/src/components/ArticleCard.tsx
  - frontend/src/components/PostCard.tsx
  - frontend/src/hooks/useArticles.ts
  - frontend/src/hooks/useSocialPosts.ts
  - frontend/src/components/NarrativeTimeline.tsx
  - frontend/src/hooks/useNarrativeEvents.ts
  - frontend/src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Left panel shows a scrollable stack of event cards (articles and social posts interleaved by timestamp)"
    - "New articles and posts pop in at the top of the feed as they arrive via realtime subscription"
    - "Article cards show title, domain, tone score, and published time"
    - "Post cards show channel, text excerpt, category tag, and timestamp"
    - "Bottom panel shows a narrative timeline visualization of correlation events building over time"
  artifacts:
    - path: "frontend/src/components/EventFeed.tsx"
      provides: "Left panel scrollable feed combining articles and posts"
      contains: "ArticleCard"
    - path: "frontend/src/components/ArticleCard.tsx"
      provides: "Card component for state media articles"
      contains: "tone_score"
    - path: "frontend/src/components/PostCard.tsx"
      provides: "Card component for social media posts"
      contains: "channel"
    - path: "frontend/src/components/NarrativeTimeline.tsx"
      provides: "Bottom panel narrative correlation timeline"
      contains: "recharts"
  key_links:
    - from: "frontend/src/hooks/useArticles.ts"
      to: "Supabase articles table"
      via: "initial fetch + realtime subscription"
      pattern: "articles"
    - from: "frontend/src/hooks/useSocialPosts.ts"
      to: "Supabase social_posts table"
      via: "initial fetch + realtime subscription"
      pattern: "social_posts"
    - from: "frontend/src/components/EventFeed.tsx"
      to: "frontend/src/hooks/useArticles.ts"
      via: "consumes articles for card rendering"
      pattern: "useArticles"
    - from: "frontend/src/components/NarrativeTimeline.tsx"
      to: "Supabase narrative_events table"
      via: "fetches narrative events for timeline"
      pattern: "narrative_events"
---

<objective>
Build the left event feed panel and bottom narrative timeline — the intelligence flow and correlation story panels.

Purpose: The left feed shows the analyst the flow of incoming intelligence (articles and civilian posts stacking in real-time). The bottom narrative timeline shows how the coordination story builds over time, replacing the dual-axis correlation chart. Together they convey "the situation is developing."

Output: Left panel with auto-updating article and post cards, bottom panel with a timeline visualization of narrative events.
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization/04-CONTEXT.md
@.planning/phases/04-visualization/04-01-SUMMARY.md
@src/models/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Left panel event feed with article and post cards</name>
  <files>
    frontend/src/components/EventFeed.tsx
    frontend/src/components/ArticleCard.tsx
    frontend/src/components/PostCard.tsx
    frontend/src/hooks/useArticles.ts
    frontend/src/hooks/useSocialPosts.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the left panel event feed — a scrollable stack of cards that pop in as new intelligence arrives.

    **useArticles hook** (`frontend/src/hooks/useArticles.ts`):
    - On mount, fetch articles from `articles` table ordered by `published_at` desc, limit 50
    - Subscribe to realtime INSERT events on `articles`
    - New articles prepend to the top of the array
    - Return: `{ articles: Article[], loading: boolean }`

    **useSocialPosts hook** (`frontend/src/hooks/useSocialPosts.ts`):
    - On mount, fetch social_posts from `social_posts` table ordered by `timestamp` desc, limit 50
    - Subscribe to realtime INSERT events on `social_posts`
    - New posts prepend to the top of the array
    - Return: `{ posts: SocialPost[], loading: boolean }`

    **ArticleCard component** (`frontend/src/components/ArticleCard.tsx`):
    - Small card with left color accent border (red for very negative tone < -5, amber for moderate -5 to -2, green for neutral > -2)
    - Shows: title (bold, truncated to 2 lines), domain badge (e.g., "xinhua.net" in a small pill), tone score, relative time (e.g., "2m ago")
    - Light background (white), subtle shadow, rounded corners
    - Compact: ~80px height

    **PostCard component** (`frontend/src/components/PostCard.tsx`):
    - Small card similar to ArticleCard but with different styling to distinguish
    - Shows: channel name (e.g., "@ChinaOSINT" in blue pill), text excerpt (truncated to 2 lines), view count, relative time
    - Left border accent in blue
    - Compact: ~80px height

    **EventFeed component** (`frontend/src/components/EventFeed.tsx`):
    - Combines articles and posts into a single interleaved feed sorted by timestamp (most recent first)
    - Each item gets a union type: `{ type: 'article', data: Article, sortTime: string } | { type: 'post', data: SocialPost, sortTime: string }`
    - Renders ArticleCard for articles, PostCard for posts
    - Container: `overflow-y-auto`, full height of the left panel zone, `px-3 py-2` padding
    - New items appear at top with a brief fade-in CSS animation (`animate-fadeIn` custom keyframe: opacity 0 to 1 over 300ms)
    - Show "INTELLIGENCE FEED" header at top in small caps, muted color
    - When loading, show a subtle skeleton loader (2-3 gray rectangles)

    **Wire into DashboardLayout**: Replace the feed placeholder with `<EventFeed />`.

    WHY: User specified event cards stack/pop in as new data arrives — feels alive. Interleaved feed shows the analyst a unified intelligence flow. Left border accents provide instant visual categorization.
  </action>
  <verify>
    Run `npm run dev`, open browser. Left panel shows "INTELLIGENCE FEED" header and cards for existing articles/posts from Supabase (60 articles + 120 posts). Cards are sorted by timestamp, most recent first. Article cards show title/domain/tone, post cards show channel/text/views. Panel scrolls independently. `npx tsc --noEmit` passes.
  </verify>
  <done>Left panel renders interleaved feed of article and post cards sorted by time. New items prepend via realtime. Cards are visually distinct (red/amber/green accent for articles, blue for posts).</done>
</task>

<task type="auto">
  <name>Task 2: Bottom narrative timeline panel</name>
  <files>
    frontend/src/components/NarrativeTimeline.tsx
    frontend/src/hooks/useNarrativeEvents.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the bottom panel narrative timeline — the correlation visualization that replaces the dual-axis chart.

    **useNarrativeEvents hook** (`frontend/src/hooks/useNarrativeEvents.ts`):
    - On mount, fetch all narrative_events ordered by `detected_at` asc
    - Also fetch the current alert to get the threat_score timeline from `correlation_metadata.detection_history`
    - Subscribe to realtime INSERT events on `narrative_events`
    - Return: `{ events: NarrativeEvent[], detectionHistory: Array<{detected_at: string, score: number, level: string}>, loading: boolean }`

    **NarrativeTimeline component** (`frontend/src/components/NarrativeTimeline.tsx`):
    - Uses Recharts `AreaChart` (or `ComposedChart`) to show the correlation story over time
    - X-axis: time (from alert detection_history entries, formatted as relative time or short date)
    - Y-axis: threat score (0-100)
    - Area fill: gradient that changes color based on score ranges:
      - 0-30: green fill
      - 30-70: amber fill
      - 70-100: red fill
    - Reference lines at y=30 (GREEN/AMBER boundary) and y=70 (AMBER/RED boundary), dashed, subtle
    - If no detection_history data yet, show a flat line at 0 with text "Awaiting correlation data..."
    - Add narrative event dots as scatter points along the timeline — each dot is a narrative event at its detected_at time, y-position based on confidence. Tooltip shows event summary.
    - Header: "NARRATIVE CORRELATION TIMELINE" in small caps, muted, above the chart
    - Container: full width of bottom zone, ~180px chart height, white background, subtle top border

    **Fallback for empty state**: If narrative_events table is empty (0 rows currently), show the empty chart frame with the reference lines and "Awaiting correlation data..." centered text. This is the expected state until the correlation engine runs.

    **Wire into DashboardLayout**: Replace the timeline placeholder with `<NarrativeTimeline />`.

    WHY: User replaced DASH-02 (dual-axis chart) with this bottom narrative timeline. The timeline IS the correlation visualization — it shows how the coordination story builds from GREEN through AMBER to RED, with narrative events as data points along the journey.
  </action>
  <verify>
    Run `npm run dev`, open browser. Bottom panel shows the timeline chart frame with reference lines at 30 and 70. Since narrative_events is empty (0 rows), it shows "Awaiting correlation data..." placeholder. Chart axes render correctly. `npx tsc --noEmit` passes.
  </verify>
  <done>Bottom panel renders narrative correlation timeline with Recharts. Shows threat score over time with color-coded zones. Displays narrative events as data points. Handles empty state gracefully.</done>
</task>

</tasks>

<verification>
1. Left panel shows interleaved feed of articles and posts
2. Article cards display title, domain, tone score, time
3. Post cards display channel, text, views, time
4. Feed auto-updates when new rows inserted in Supabase
5. Bottom panel shows Recharts timeline with GREEN/AMBER/RED zones
6. Timeline shows reference lines at 30 and 70
7. Empty state handled gracefully (0 narrative events)
8. `npx tsc --noEmit` passes
9. `npm run dev` runs without errors
</verification>

<success_criteria>
- Left panel renders 170+ cards (60 articles + 120 posts interleaved)
- Cards visually distinguish articles (red/amber/green accent) from posts (blue accent)
- New items auto-prepend via realtime subscriptions
- Bottom panel renders Recharts area chart with threat score zones
- Narrative events appear as scatter points on timeline
- Both panels wired into DashboardLayout grid
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization/04-03-SUMMARY.md`
</output>
