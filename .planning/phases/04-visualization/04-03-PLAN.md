---
phase: 04-visualization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/EventFeed.tsx
  - frontend/src/components/ArticleCard.tsx
  - frontend/src/components/PostCard.tsx
  - frontend/src/hooks/useArticles.ts
  - frontend/src/hooks/useSocialPosts.ts
  - frontend/src/hooks/useNarrativeEvents.ts
  - frontend/src/hooks/useMovementEvents.ts
  - frontend/src/components/NarrativeTimeline.tsx
  - frontend/src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Left panel shows a scrollable stack of event cards (articles and social posts interleaved by timestamp)"
    - "New articles and posts pop in at the top of the feed as they arrive via realtime subscription"
    - "Article cards show title, domain, tone score, published time, and a 'Coordinated' badge when the article is part of a narrative coordination event"
    - "Post cards show channel, text excerpt, movement category tags (convoy/naval/flight/restricted zone), location tags, and timestamp"
    - "Bottom panel shows a narrative timeline visualization of correlation events building over time"
  artifacts:
    - path: "frontend/src/components/EventFeed.tsx"
      provides: "Left panel scrollable feed combining articles and posts"
      contains: "ArticleCard"
    - path: "frontend/src/components/ArticleCard.tsx"
      provides: "Card component for state media articles"
      contains: "tone_score"
    - path: "frontend/src/components/PostCard.tsx"
      provides: "Card component for social media posts with movement category and location tags"
      contains: "channel"
    - path: "frontend/src/hooks/useMovementEvents.ts"
      provides: "Movement events data for post category/location enrichment"
      contains: "movement_events"
    - path: "frontend/src/components/NarrativeTimeline.tsx"
      provides: "Bottom panel narrative correlation timeline"
      contains: "recharts"
  key_links:
    - from: "frontend/src/hooks/useArticles.ts"
      to: "Supabase articles table"
      via: "initial fetch + realtime subscription"
      pattern: "articles"
    - from: "frontend/src/hooks/useSocialPosts.ts"
      to: "Supabase social_posts table"
      via: "initial fetch + realtime subscription"
      pattern: "social_posts"
    - from: "frontend/src/components/EventFeed.tsx"
      to: "frontend/src/hooks/useArticles.ts"
      via: "consumes articles for card rendering"
      pattern: "useArticles"
    - from: "frontend/src/components/ArticleCard.tsx"
      to: "Supabase narrative_events table"
      via: "cross-references source_ids to detect coordination membership"
      pattern: "narrative_events.*source_ids"
    - from: "frontend/src/components/PostCard.tsx"
      to: "Supabase movement_events table"
      via: "matches movement events to display category and location tags"
      pattern: "movement_events.*event_type"
    - from: "frontend/src/components/NarrativeTimeline.tsx"
      to: "Supabase narrative_events table"
      via: "fetches narrative events for timeline"
      pattern: "narrative_events"
---

<objective>
Build the left event feed panel and bottom narrative timeline — the intelligence flow and correlation story panels.

Purpose: The left feed shows the analyst the flow of incoming intelligence (articles and civilian posts stacking in real-time). The bottom narrative timeline shows how the coordination story builds over time, replacing the dual-axis correlation chart. Together they convey "the situation is developing."

Output: Left panel with auto-updating article and post cards, bottom panel with a timeline visualization of narrative events.
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization/04-CONTEXT.md
@.planning/phases/04-visualization/04-01-SUMMARY.md
@src/models/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Left panel event feed with article and post cards</name>
  <files>
    frontend/src/components/EventFeed.tsx
    frontend/src/components/ArticleCard.tsx
    frontend/src/components/PostCard.tsx
    frontend/src/hooks/useArticles.ts
    frontend/src/hooks/useSocialPosts.ts
    frontend/src/hooks/useNarrativeEvents.ts
    frontend/src/hooks/useMovementEvents.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the left panel event feed — a scrollable stack of cards that pop in as new intelligence arrives. Cards must display coordination signals (DASH-03) and movement classifications (DASH-04).

    **useArticles hook** (`frontend/src/hooks/useArticles.ts`):
    - On mount, fetch articles from `articles` table ordered by `published_at` desc, limit 50
    - Subscribe to realtime INSERT events on `articles`
    - New articles prepend to the top of the array
    - Return: `{ articles: Article[], loading: boolean }`

    **useSocialPosts hook** (`frontend/src/hooks/useSocialPosts.ts`):
    - On mount, fetch social_posts from `social_posts` table ordered by `timestamp` desc, limit 50
    - Subscribe to realtime INSERT events on `social_posts`
    - New posts prepend to the top of the array
    - Return: `{ posts: SocialPost[], loading: boolean }`

    **useNarrativeEvents hook** (`frontend/src/hooks/useNarrativeEvents.ts`) — also used by Task 2 timeline:
    - On mount, fetch all narrative_events from `narrative_events` table
    - Subscribe to realtime INSERT events on `narrative_events`
    - Build a Set of coordinated article IDs by iterating all narrative_events and collecting IDs from each event's `source_ids` JSONB array (these are article IDs that triggered the coordination detection)
    - Return: `{ events: NarrativeEvent[], coordinatedArticleIds: Set<string>, loading: boolean }`

    **useMovementEvents hook** (`frontend/src/hooks/useMovementEvents.ts`):
    - On mount, fetch all movement_events from `movement_events` table
    - Subscribe to realtime INSERT events on `movement_events`
    - Build a Map keyed by social post association: iterate movement_events and extract any social post references from the event's description or associated data. Since movement_events have `event_type` (convoy/naval/flight/restricted_zone), `description`, `location_lat`, `location_lon` — build a lookup structure that the PostCard can query.
    - Strategy: movement_events don't have a direct foreign key to social_posts, but the Phase 2 classifier creates movement_events FROM social posts. The connection is temporal: match movement_events to social_posts by finding movement_events whose `detected_at` is within 60 seconds of a social_post's `timestamp` AND whose `description` contains keywords from the post text. Alternatively, if movement_events store source info in description, parse it.
    - Simpler approach: Pass all movement_events to the EventFeed, and for each social_post, find movement_events whose `detected_at` is closest in time (within 5 minutes) as a best-effort match. This is a demo — approximate matching is acceptable.
    - Return: `{ movementEvents: MovementEvent[], loading: boolean }`

    **ArticleCard component** (`frontend/src/components/ArticleCard.tsx`):
    - Small card with left color accent border (red for very negative tone < -5, amber for moderate -5 to -2, green for neutral > -2)
    - Shows: title (bold, truncated to 2 lines), domain badge (e.g., "xinhua.net" in a small pill), tone score, relative time (e.g., "2m ago")
    - **Coordination signal (DASH-03):** Accept a `isCoordinated: boolean` prop. When true:
      - Override left border color to `border-purple-500` (purple = coordination signal)
      - Show a small "COORDINATED" badge (purple pill, text-xs, uppercase) next to the domain badge
      - This visually marks articles that are part of a narrative coordination event detected by the Phase 2/3 pipeline
    - Light background (white), subtle shadow, rounded corners
    - Compact: ~80px height, slightly taller if coordinated badge is shown

    **PostCard component** (`frontend/src/components/PostCard.tsx`):
    - Small card similar to ArticleCard but with different styling to distinguish
    - Shows: channel name (e.g., "@ChinaOSINT" in blue pill), text excerpt (truncated to 2 lines), view count, relative time
    - **Movement event tags (DASH-04):** Accept optional `movementEvent: MovementEvent | null` prop. When a matched movement event exists:
      - Show a category tag pill below the text: event_type value displayed as uppercase badge. Color by category:
        - "convoy": `bg-orange-100 text-orange-700`
        - "naval": `bg-blue-100 text-blue-700`
        - "flight": `bg-sky-100 text-sky-700`
        - "restricted_zone": `bg-red-100 text-red-700`
        - default: `bg-slate-100 text-slate-600`
      - Show location tag if `location_lat` and `location_lon` are present: small text-xs muted text showing approximate location (e.g., "24.5°N, 120.0°E")
    - Left border accent in blue (default) or category-specific color if movement event matched
    - Compact: ~80-90px height

    **EventFeed component** (`frontend/src/components/EventFeed.tsx`):
    - Combines articles and posts into a single interleaved feed sorted by timestamp (most recent first)
    - Each item gets a union type: `{ type: 'article', data: Article, sortTime: string } | { type: 'post', data: SocialPost, sortTime: string }`
    - Consumes `coordinatedArticleIds` from useNarrativeEvents to pass `isCoordinated` prop to each ArticleCard
    - Consumes `movementEvents` from useMovementEvents. For each social post, find the closest movement_event by timestamp (within 5 minutes) and pass as `movementEvent` prop to PostCard
    - Renders ArticleCard for articles, PostCard for posts
    - Container: `overflow-y-auto`, full height of the left panel zone, `px-3 py-2` padding
    - New items appear at top with a brief fade-in CSS animation (`animate-fadeIn` custom keyframe: opacity 0 to 1 over 300ms)
    - Show "INTELLIGENCE FEED" header at top in small caps, muted color
    - When loading, show a subtle skeleton loader (2-3 gray rectangles)

    **Wire into DashboardLayout**: Replace the feed placeholder with `<EventFeed />`.

    WHY: User specified event cards stack/pop in as new data arrives — feels alive. Interleaved feed shows the analyst a unified intelligence flow. Left border accents provide instant visual categorization. DASH-03 requires coordination signals highlighted on articles — the purple "COORDINATED" badge achieves this by cross-referencing narrative_events.source_ids. DASH-04 requires movement category and location tags on posts — the category pills and location text achieve this by matching movement_events temporally.
  </action>
  <verify>
    Run `npm run dev`, open browser. Left panel shows "INTELLIGENCE FEED" header and cards for existing articles/posts from Supabase (60 articles + 120 posts). Cards are sorted by timestamp, most recent first. Article cards show title/domain/tone. Post cards show channel/text/views. If narrative_events exist with source_ids referencing article IDs, those articles show a purple "COORDINATED" badge. If movement_events exist, matched posts show category tags (convoy/naval/flight/restricted zone) and location coordinates. Panel scrolls independently. `npx tsc --noEmit` passes.
  </verify>
  <done>Left panel renders interleaved feed of article and post cards sorted by time. New items prepend via realtime. Article cards show coordination signals via purple "COORDINATED" badge when part of a narrative event (DASH-03). Post cards show movement category tags and location when matched to a movement event (DASH-04). Cards are visually distinct (red/amber/green accent for articles, blue/category-color for posts).</done>
</task>

<task type="auto">
  <name>Task 2: Bottom narrative timeline panel</name>
  <files>
    frontend/src/components/NarrativeTimeline.tsx
    frontend/src/hooks/useNarrativeEvents.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the bottom panel narrative timeline — the correlation visualization that replaces the dual-axis chart.

    **useNarrativeEvents hook** (`frontend/src/hooks/useNarrativeEvents.ts`) — already created in Task 1, extend here:
    - The hook already fetches narrative_events and builds coordinatedArticleIds (from Task 1)
    - Add: fetch the current alert to get the threat_score timeline from `correlation_metadata.detection_history`
    - Ensure events are ordered by `detected_at` asc for timeline display
    - Return: `{ events: NarrativeEvent[], coordinatedArticleIds: Set<string>, detectionHistory: Array<{detected_at: string, score: number, level: string}>, loading: boolean }`

    **NarrativeTimeline component** (`frontend/src/components/NarrativeTimeline.tsx`):
    - Uses Recharts `AreaChart` (or `ComposedChart`) to show the correlation story over time
    - X-axis: time (from alert detection_history entries, formatted as relative time or short date)
    - Y-axis: threat score (0-100)
    - Area fill: gradient that changes color based on score ranges:
      - 0-30: green fill
      - 30-70: amber fill
      - 70-100: red fill
    - Reference lines at y=30 (GREEN/AMBER boundary) and y=70 (AMBER/RED boundary), dashed, subtle
    - If no detection_history data yet, show a flat line at 0 with text "Awaiting correlation data..."
    - Add narrative event dots as scatter points along the timeline — each dot is a narrative event at its detected_at time, y-position based on confidence. Tooltip shows event summary.
    - Header: "NARRATIVE CORRELATION TIMELINE" in small caps, muted, above the chart
    - Container: full width of bottom zone, ~180px chart height, white background, subtle top border

    **Fallback for empty state**: If narrative_events table is empty (0 rows currently), show the empty chart frame with the reference lines and "Awaiting correlation data..." centered text. This is the expected state until the correlation engine runs.

    **Wire into DashboardLayout**: Replace the timeline placeholder with `<NarrativeTimeline />`.

    WHY: User replaced DASH-02 (dual-axis chart) with this bottom narrative timeline. The timeline IS the correlation visualization — it shows how the coordination story builds from GREEN through AMBER to RED, with narrative events as data points along the journey.
  </action>
  <verify>
    Run `npm run dev`, open browser. Bottom panel shows the timeline chart frame with reference lines at 30 and 70. Since narrative_events is empty (0 rows), it shows "Awaiting correlation data..." placeholder. Chart axes render correctly. `npx tsc --noEmit` passes.
  </verify>
  <done>Bottom panel renders narrative correlation timeline with Recharts. Shows threat score over time with color-coded zones. Displays narrative events as data points. Handles empty state gracefully.</done>
</task>

</tasks>

<verification>
1. Left panel shows interleaved feed of articles and posts
2. Article cards display title, domain, tone score, time, and "COORDINATED" badge when part of a narrative event (DASH-03)
3. Post cards display channel, text, views, time, movement category tags (convoy/naval/flight/restricted zone), and location tags when matched to a movement event (DASH-04)
4. Feed auto-updates when new rows inserted in Supabase
5. Bottom panel shows Recharts timeline with GREEN/AMBER/RED zones
6. Timeline shows reference lines at 30 and 70
7. Empty state handled gracefully (0 narrative events)
8. `npx tsc --noEmit` passes
9. `npm run dev` runs without errors
</verification>

<success_criteria>
- Left panel renders 170+ cards (60 articles + 120 posts interleaved)
- Cards visually distinguish articles (red/amber/green accent) from posts (blue accent)
- Articles part of coordination events show purple "COORDINATED" badge (DASH-03, via narrative_events.source_ids cross-reference)
- Posts matched to movement events show category tags (convoy/naval/flight/restricted zone) and location coordinates (DASH-04, via movement_events temporal matching)
- New items auto-prepend via realtime subscriptions
- Bottom panel renders Recharts area chart with threat score zones
- Narrative events appear as scatter points on timeline
- Both panels wired into DashboardLayout grid
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization/04-03-SUMMARY.md`
</output>
