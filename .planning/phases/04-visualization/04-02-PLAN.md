---
phase: 04-visualization
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/components/ThreatBanner.tsx
  - frontend/src/hooks/useAlerts.ts
  - frontend/src/components/MapPanel.tsx
  - frontend/src/components/DashboardLayout.tsx
autonomous: true

must_haves:
  truths:
    - "Threat banner displays GREEN status with 0% confidence when no alerts exist"
    - "Threat banner updates color and text in real-time when an alert is inserted/updated in Supabase"
    - "Map renders a fixed Taiwan Strait view with Mapbox Light style"
    - "Vessel position markers appear on map with directional icons showing heading"
    - "Map displays without requiring user interaction (no pan/zoom needed)"
  artifacts:
    - path: "frontend/src/components/ThreatBanner.tsx"
      provides: "Full-width colored threat status banner"
      contains: "THREAT LEVEL"
    - path: "frontend/src/hooks/useAlerts.ts"
      provides: "Alerts data with realtime subscription"
      contains: "useRealtimeSubscription"
    - path: "frontend/src/components/MapPanel.tsx"
      provides: "Taiwan Strait map with vessel markers"
      contains: "react-map-gl"
  key_links:
    - from: "frontend/src/hooks/useAlerts.ts"
      to: "Supabase alerts table"
      via: "initial fetch + realtime subscription on INSERT/UPDATE"
      pattern: "alerts"
    - from: "frontend/src/components/ThreatBanner.tsx"
      to: "frontend/src/hooks/useAlerts.ts"
      via: "consumes alert data for display"
      pattern: "useAlerts"
    - from: "frontend/src/components/MapPanel.tsx"
      to: "Supabase vessel_positions table"
      via: "initial fetch + realtime subscription"
      pattern: "vessel_positions"
---

<objective>
Build the threat status banner and interactive map panel — the two most visually dominant elements of the dashboard.

Purpose: The threat banner is the headline of the entire dashboard, impossible to miss on escalation. The map is the centerpiece (~50% of screen), displaying the Taiwan Strait with vessel positions and narrative focus regions. Together they deliver the core visual impact.

Output: Working threat banner that auto-updates from alerts table, and a map showing Taiwan Strait with vessel markers that update in real-time.
</objective>

<execution_context>
@/Users/gremmy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gremmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visualization/04-CONTEXT.md
@.planning/phases/04-visualization/04-01-SUMMARY.md
@src/models/threat_levels.py
@src/models/correlation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Threat status banner with realtime alerts</name>
  <files>
    frontend/src/components/ThreatBanner.tsx
    frontend/src/hooks/useAlerts.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the threat status banner — the full-width colored bar at the top of the dashboard.

    **useAlerts hook** (`frontend/src/hooks/useAlerts.ts`):
    - On mount, fetch the most recent active (unresolved) alert from the `alerts` table: `.select('*').is('resolved_at', null).order('created_at', { ascending: false }).limit(1)`
    - Subscribe to realtime INSERT and UPDATE events on the `alerts` table
    - When a new alert arrives or an existing one updates, replace the current alert state if the new one is more recent
    - Return: `{ alert: Alert | null, loading: boolean }`

    **ThreatBanner component** (`frontend/src/components/ThreatBanner.tsx`):
    - Full-width bar, ~56px height, centered text
    - Background color based on `alert.threat_level`:
      - GREEN: `bg-emerald-500` (green-500 family)
      - AMBER: `bg-amber-500`
      - RED: `bg-red-600`
      - No alert / loading: `bg-slate-300` with "INITIALIZING..." text
    - Text format: `THREAT LEVEL: {LEVEL} — {confidence}% confidence` in bold white uppercase
    - When threat level changes (escalates), add a brief CSS animation — a pulse/flash effect using Tailwind `animate-pulse` for 2 seconds then stop. Use a useEffect that detects level changes and applies a temporary class.
    - Font: bold, tracking-wide, text-sm or text-base

    **Wire into DashboardLayout**: Replace the banner placeholder with `<ThreatBanner />`.

    WHY: User specified the threat banner should be "impossible to miss when it escalates." Full-width colored background with large text achieves this. Realtime subscription ensures instant updates.
  </action>
  <verify>
    Run `npm run dev`, open browser. Banner shows at top of dashboard in slate gray with "INITIALIZING..." (no alerts in DB yet). Insert a test alert via Supabase SQL editor: `INSERT INTO alerts (severity, title, threat_level, threat_score, confidence) VALUES ('medium', 'Test', 'AMBER', 55, 67);` — banner should turn amber and show "THREAT LEVEL: AMBER — 67% confidence". `npx tsc --noEmit` passes.
  </verify>
  <done>Threat banner renders with correct color coding, displays threat level and confidence, auto-updates via realtime subscription when alerts are inserted or updated.</done>
</task>

<task type="auto">
  <name>Task 2: Taiwan Strait map with vessel markers</name>
  <files>
    frontend/src/components/MapPanel.tsx
    frontend/src/hooks/useVesselPositions.ts
    frontend/src/components/DashboardLayout.tsx
  </files>
  <action>
    Create the map panel — the centerpiece of the dashboard.

    **useVesselPositions hook** (`frontend/src/hooks/useVesselPositions.ts`):
    - On mount, fetch all vessel positions from `vessel_positions` table, ordered by timestamp desc
    - Group by MMSI — keep only the latest position per vessel
    - Subscribe to realtime INSERT events on `vessel_positions`
    - When new position arrives, update the vessel's position in state (latest position per MMSI)
    - Return: `{ vessels: Map<number, VesselPosition>, loading: boolean }`

    **MapPanel component** (`frontend/src/components/MapPanel.tsx`):
    - Use `react-map-gl` with Mapbox `mapbox://styles/mapbox/light-v11` style
    - NOTE: Mapbox requires an access token. Use an environment variable `VITE_MAPBOX_TOKEN`. In the component, read `import.meta.env.VITE_MAPBOX_TOKEN`. If token is not set, render a fallback: a light gray div with a simple SVG outline of the Taiwan Strait (lat 23-26, lon 118-122) and text "Map: Set VITE_MAPBOX_TOKEN for Mapbox". This ensures the app works without a Mapbox account.
    - Fixed view centered on Taiwan Strait: `latitude: 24.5, longitude: 120.0, zoom: 6.5`
    - Disable all interaction: `scrollZoom={false}`, `dragPan={false}`, `dragRotate={false}`, `doubleClickZoom={false}`, `touchZoomRotate={false}`
    - Render vessel markers using `<Marker>` components for each unique vessel:
      - Icon: A small triangle/arrow shape (CSS or inline SVG) rotated by `course` degrees to show heading
      - Color: `text-blue-600` for normal vessels
      - Size: ~16px
      - On new position update, add a brief CSS `animate-ping` effect (single ping, not continuous) to indicate the update — use a state flag that clears after 1 second
    - Tooltip on hover: Show ship_name, speed, and course

    **Wire into DashboardLayout**: Replace the map placeholder with `<MapPanel />`.

    WHY: User specified clean minimal base map (Mapbox Light), directional ship/arrow icons, fixed view locked to Taiwan Strait, instant snap with brief pulse effect on position updates. The fallback ensures the demo works without a Mapbox API key.
  </action>
  <verify>
    Run `npm run dev`, open browser. Map zone shows either the Mapbox map (if VITE_MAPBOX_TOKEN is set) or the fallback SVG placeholder. Vessel markers appear at their positions. `npx tsc --noEmit` passes. If Mapbox token is set, map shows light style centered on Taiwan Strait with no ability to pan/zoom.
  </verify>
  <done>Map panel renders Taiwan Strait with vessel position markers. Markers show directional heading. Positions update in real-time via Supabase subscription. Works with or without Mapbox token.</done>
</task>

</tasks>

<verification>
1. Threat banner visible at top with correct color for current threat level
2. Banner auto-updates when alert inserted/updated in Supabase
3. Map shows Taiwan Strait region (fixed, no pan/zoom)
4. Vessel markers appear on map at correct positions
5. Vessel markers show directional heading via rotated icon
6. `npx tsc --noEmit` passes with no errors
7. `npm run dev` runs without errors
</verification>

<success_criteria>
- Threat banner displays GREEN/AMBER/RED with confidence score
- Threat banner auto-updates via Supabase realtime subscription
- Map renders Taiwan Strait with Mapbox Light style (or fallback without token)
- Vessel markers show position and heading direction
- New vessel positions trigger brief visual pulse effect
- Both components wired into the DashboardLayout grid
</success_criteria>

<output>
After completion, create `.planning/phases/04-visualization/04-02-SUMMARY.md`
</output>
